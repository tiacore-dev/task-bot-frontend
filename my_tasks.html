<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–æ—ë –∑–∞–¥–∞–Ω–∏–µ</title>
    <link rel="stylesheet" href="/static/styles.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="./env.js"></script>
</head>
<body>
    <div class="container">
        <h2 id="task-title">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞–Ω–∏—è...</h2>
        <p id="task-description"></p>
        <p id="task-reward"></p>

        <div id="submission-form" style="display: none;">
            <h4>üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</h4>
            <div class="mb-3">
                <label for="screenshot" class="form-label">–°–∫—Ä–∏–Ω—à–æ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</label>
                <input type="file" id="screenshot" accept="image/*" class="form-control">
            </div>
            <div class="mb-3">
                <label for="comment" class="form-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                <textarea id="comment" class="form-control" rows="3" placeholder="–û–ø–∏—à–∏—Ç–µ, —á—Ç–æ –≤—ã —Å–¥–µ–ª–∞–ª–∏..."></textarea>
            </div>
            <button class="btn btn-primary" onclick="submitTask()">üì® –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É</button>
        </div>

        <button class="btn btn-secondary mt-3" onclick="goBack()">‚¨Ö –ù–∞–∑–∞–¥</button>
    </div>

    <!-- üîç –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ª–æ–≥–æ–≤ -->
    <p id="debug-log" style="font-size: 12px; color: gray; white-space: pre-wrap;"></p>

    <script>
        const tg = window.Telegram.WebApp;
        const apiUrl = window.env.API_URL;
        const telegramId = tg.initDataUnsafe?.user?.id;
        const urlParams = new URLSearchParams(window.location.search);
        const taskId = urlParams.get("task_id");

        function logDebug(message) {
            console.log(message);
            const logEl = document.getElementById("debug-log");
            if (logEl) logEl.innerText += `\n${message}`;
        }

        function goBack() {
            window.location.href = "/tasks.html";
        }

        async function loadTask() {
            try {
                logDebug("üì¶ –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–¥–∞—á—É...");

                const myTasks = JSON.parse(localStorage.getItem("my_tasks")) || [];
                logDebug(`üìÅ –ù–∞–π–¥–µ–Ω–æ ${myTasks.length} –∑–∞–¥–∞–Ω–∏–π –≤ localStorage`);

                const task = myTasks.find(t => t.task_id === taskId);
                logDebug(`üîç taskId –∏–∑ URL: ${taskId}`);

                if (!task) {
                    logDebug("‚ùå –ó–∞–¥–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ");
                    document.getElementById("task-title").innerText = "–û—à–∏–±–∫–∞: –∑–∞–¥–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ";
                    return;
                }

                const assignmentId = localStorage.getItem("assignment_id");
                logDebug(`üìå assignment_id –∏–∑ localStorage: ${assignmentId}`);

                const response = await fetch(`${apiUrl}/assignments/${assignmentId}?telegram_id=${telegramId}`);
                const data = await response.json();
                logDebug(`üì® –û—Ç–≤–µ—Ç –æ—Ç /assignments: ${JSON.stringify(data)}`);

                document.getElementById("task-title").innerText = task.description;
                document.getElementById("task-description").innerText = `–û–ø–∏—Å–∞–Ω–∏–µ: ${task.description}`;
                document.getElementById("task-reward").innerText = `üí∞ –í–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ: ${task.reward}`;

                if (data.assignment_status === "in_progress") {
                    logDebug("‚úÖ –°—Ç–∞—Ç—É—Å: in_progress ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –æ—Ç–ø—Ä–∞–≤–∫–∏");
                    document.getElementById("submission-form").style.display = "block";
                } else {
                    logDebug(`‚õî –°—Ç–∞—Ç—É—Å: ${data.assignment_status} ‚Äî —Ñ–æ—Ä–º—É –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º`);
                }

            } catch (err) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞–Ω–∏—è:", err);
                logDebug(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${err}`);
            }
        }

        async function submitTask() {
            const comment = document.getElementById("comment").value.trim();
            const fileInput = document.getElementById("screenshot");
            const file = fileInput.files[0];
            const assignmentId = localStorage.getItem("assignment_id");

            if (!assignmentId) {
                alert("‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω ID –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É.");
                logDebug("‚ùå assignment_id –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ localStorage");
                return;
            }

            if (!file) {
                alert("‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç");
                logDebug("‚ùå –°–∫—Ä–∏–Ω—à–æ—Ç –Ω–µ –ø—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω");
                return;
            }

            logDebug("üöÄ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–¥–∞–Ω–∏–µ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É...");
            logDebug(`üìé –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${comment}`);
            logDebug(`üñº –§–∞–π–ª: ${file.name}, —Ä–∞–∑–º–µ—Ä: ${file.size} –±–∞–π—Ç`);
            logDebug(`üìå assignment_id: ${assignmentId}`);

            const formData = new FormData();
            formData.append("screenshot", file);
            formData.append("comment", comment);
            formData.append("assignment_id", assignmentId);

            try {
                const response = await fetch(`${apiUrl}/tasks/${taskId}/submit?telegram_id=${telegramId}`, {
                    method: "POST",
                    body: formData,
                });

                const result = await response.json();
                logDebug(`üì¨ –û—Ç–≤–µ—Ç –æ—Ç submit: ${JSON.stringify(result)}`);

                if (response.ok) {
                    alert("‚úÖ –ó–∞–¥–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É!");
                    goBack();
                } else {
                    alert(`‚ùå –û—à–∏–±–∫–∞: ${result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
                }
            } catch (error) {
                logDebug(`‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ${error}`);
                alert("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–¥–∞–Ω–∏—è: " + error);
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            tg.expand();
            loadTask();
        });
    </script>
</body>
</html>
