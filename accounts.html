<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–æ–∏ –∞–∫–∫–∞—É–Ω—Ç—ã</title>
    <link rel="stylesheet" href="/static/styles.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="./env.js"></script>
</head>
<body>
    <div class="container">
        <h2>–ü—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã</h2>
        <ul id="accounts-list"></ul>

        <h3>‚ûï –ü—Ä–∏–≤—è–∑–∞—Ç—å –Ω–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç</h3>
        <label for="platform">–í—ã–±–µ—Ä–∏—Ç–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—É:</label>
        <select id="platform">
            <option value="youtube">YouTube</option>
            <option value="twitter">Twitter</option>
            <option value="telegram">Telegram</option>
            <option value="instagram">Instagram</option>
        </select>

        <input type="text" id="account-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞">
        <input type="text" id="account-platform-id" placeholder="ID –∞–∫–∫–∞—É–Ω—Ç–∞">
        <button onclick="addAccount()">‚ûï –ü—Ä–∏–≤—è–∑–∞—Ç—å</button>

        <button onclick="goBack()">üîô –ù–∞–∑–∞–¥</button>

        <p id="debug-log" style="font-size: 12px; color: gray; white-space: pre-wrap;"></p>
    </div>

    <script>
        function logDebug(message) {
            console.log(message);
            document.getElementById("debug-log").innerText += `\n${message}`;
        }

        // üìå –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function loadAccounts() {
            const tg = window.Telegram.WebApp;
            const apiUrl = window.env.API_URL;
            const telegramId = tg.initDataUnsafe?.user?.id;

            logDebug(`üìå –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–∫–∫–∞—É–Ω—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${telegramId}`);

            try {
                const response = await fetch(`${apiUrl}/account?telegram_id=${telegramId}`, {
                    headers: { "Accept": "application/json", "ngrok-skip-browser-warning": "true" }
                });

                const data = await response.json();
                if (response.ok) {
                    const accountsList = document.getElementById("accounts-list");
                    accountsList.innerHTML = "";

                    data.forEach(account => {
                        const li = document.createElement("li");
                        li.innerHTML = `
                            <b>${account.account_name}</b> (${account.platform})
                            <br>üÜî ${account.account_platform_id}
                            <button onclick="selectAccount(${account.account_id})">‚úî –í—ã–±—Ä–∞—Ç—å</button>
                        `;
                        accountsList.appendChild(li);
                    });

                } else {
                    alert(data.error);
                }
            } catch (error) {
                logDebug(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–æ–≤: ${error}`);
            }
        }

        // üìå –ü—Ä–∏–≤—è–∑–∫–∞ –Ω–æ–≤–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞
        async function addAccount() {
            const tg = window.Telegram.WebApp;
            const apiUrl = window.env.API_URL;
            const telegramId = tg.initDataUnsafe?.user?.id;

            const platform = document.getElementById("platform").value;
            const accountName = document.getElementById("account-name").value;
            const accountPlatformId = document.getElementById("account-platform-id").value;

            if (!accountName || !accountPlatformId) {
                alert("‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!");
                return;
            }

            logDebug(`üìå –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –∞–∫–∫–∞—É–Ω—Ç: ${accountName} (${platform})`);

            try {
                const response = await fetch(`${apiUrl}/account`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        telegram_id: telegramId,
                        platform: platform,
                        account_name: accountName,
                        account_platform_id: accountPlatformId
                    })
                });

                const data = await response.json();
                if (response.ok) {
                    alert("‚úÖ –ê–∫–∫–∞—É–Ω—Ç –ø—Ä–∏–≤—è–∑–∞–Ω!");
                    loadAccounts();
                } else {
                    alert(`‚ùå –û—à–∏–±–∫–∞: ${data.error}`);
                }
            } catch (error) {
                logDebug(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏–≤—è–∑–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–∞: ${error}`);
            }
        }

        function selectAccount(accountId) {
            localStorage.setItem("selectedAccount", accountId);
            window.location.href = "/tasks.html";
        }

        function goBack() {
            window.location.href = "/tasks.html";
        }

        document.addEventListener("DOMContentLoaded", loadAccounts);
    </script>
</body>
</html>
