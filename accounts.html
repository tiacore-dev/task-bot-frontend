<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–æ–∏ –∞–∫–∫–∞—É–Ω—Ç—ã</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="./env.js"></script>
</head>
<body>
<div class="container py-4">
    <h2 class="mb-4">üì± –ü—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã</h2>

    <ul id="accounts-list" class="list-group mb-4"></ul>

    <h4 class="mb-3">‚ûï –ü—Ä–∏–≤—è–∑–∞—Ç—å –Ω–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç</h4>
    <div class="mb-3">
        <label for="platform" class="form-label">–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞</label>
        <select id="platform" class="form-select"></select>
    </div>
    <div class="mb-3">
        <label for="account-name" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞</label>
        <input type="text" id="account-name" class="form-control" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: –º–æ–π_–∫–∞–Ω–∞–ª">
    </div>
    <div class="mb-3">
        <label for="account-platform-id" class="form-label">ID –∞–∫–∫–∞—É–Ω—Ç–∞</label>
        <input type="text" id="account-platform-id" class="form-control" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: UC123456...">
    </div>
    <button class="btn btn-success mb-4" onclick="addAccount()">–ü—Ä–∏–≤—è–∑–∞—Ç—å</button>
    <br>
    <button class="btn btn-outline-secondary" onclick="goBack()">‚¨Ö –ù–∞–∑–∞–¥</button>

    <pre id="debug-log" class="mt-4 small text-muted"></pre>
</div>

<script>
    function logDebug(message) {
        console.log(message);
        document.getElementById("debug-log").innerText += `\n${message}`;
    }

    const tg = window.Telegram.WebApp;
    const apiUrl = window.env.API_URL;
    const telegramId = tg.initDataUnsafe?.user?.id;

    async function loadPlatforms() {
        try {
            const res = await fetch(`${apiUrl}/platforms`, {
                headers: { "Accept": "application/json", "ngrok-skip-browser-warning": "true" }
            });
            const platforms = await res.json();
            if (res.ok) {
                localStorage.setItem("task_platforms", JSON.stringify(platforms));

                const select = document.getElementById("platform");
                select.innerHTML = "";
                platforms.forEach(p => {
                    const option = document.createElement("option");
                    option.value = p.platform_id;
                    option.textContent = p.platform_name;
                    select.appendChild(option);
                });
                logDebug("‚úÖ –ü–ª–∞—Ç—Ñ–æ—Ä–º—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã");
            } else {
                alert("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã");
            }
        } catch (err) {
            logDebug(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º: ${err}`);
        }
    }

    async function loadAccounts() {
        logDebug(`üìå –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–∫–∫–∞—É–Ω—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${telegramId}`);

        try {
            const response = await fetch(`${apiUrl}/accounts?telegram_id=${telegramId}`, {
                headers: { "Accept": "application/json", "ngrok-skip-browser-warning": "true" }
            });

            const data = await response.json();
            if (response.ok) {
                const accountsList = document.getElementById("accounts-list");
                accountsList.innerHTML = "";

                data.forEach(account => {
                    const li = document.createElement("li");
                    li.classList.add("list-group-item");
                    li.innerHTML = `
                        <b>${account.account_name}</b> (${account.platform})<br>
                        üÜî ${account.account_platform_id}
                        <button class="btn btn-sm btn-outline-primary mt-2" onclick="selectAccount(${account.account_id})">‚úî –í—ã–±—Ä–∞—Ç—å</button>
                    `;
                    accountsList.appendChild(li);
                });

            } else {
                alert(data.error);
            }
        } catch (error) {
            logDebug(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–æ–≤: ${error}`);
        }
    }

    async function addAccount() {
        const platformId = document.getElementById("platform").value;
        const accountName = document.getElementById("account-name").value.trim();
        const accountPlatformId = document.getElementById("account-platform-id").value.trim();

        if (!platformId || !accountName || !accountPlatformId) {
            alert("‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!");
            return;
        }

        try {
            const response = await fetch(`${apiUrl}/accounts?telegram_id=${telegramId}`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "ngrok-skip-browser-warning": "true"
                },
                body: JSON.stringify({
                    platform: platformId,
                    account_name: accountName,
                    account_platform_id: accountPlatformId
                })
            });

            const data = await response.json();
            if (response.ok) {
                alert("‚úÖ –ê–∫–∫–∞—É–Ω—Ç –ø—Ä–∏–≤—è–∑–∞–Ω!");
                loadAccounts();
            } else {
                alert(`‚ùå –û—à–∏–±–∫–∞: ${data.error}`);
            }
        } catch (error) {
            logDebug(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏–≤—è–∑–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–∞: ${error}`);
        }
    }

    function selectAccount(accountId) {
        localStorage.setItem("selectedAccount", accountId);
        window.location.href = "/tasks.html";
    }

    function goBack() {
        window.location.href = "/tasks.html";
    }

    document.addEventListener("DOMContentLoaded", () => {
        tg.expand();
        loadPlatforms();
        loadAccounts();
    });
</script>
</body>
</html>
