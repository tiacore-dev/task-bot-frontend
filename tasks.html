<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ó–∞–¥–∞–Ω–∏—è</title>
    <link rel="stylesheet" href="/static/styles.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="./env.js"></script>  <!-- –ó–∞–≥—Ä—É–∂–∞–µ–º API_URL -->
</head>
<body>
    <div class="container">
        <h2>–ó–∞–¥–∞–Ω–∏—è</h2>
        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('available')">üìå –î–æ—Å—Ç—É–ø–Ω—ã–µ</button>
            <button class="tab-btn" onclick="showTab('active')">üöÄ –ê–∫—Ç–∏–≤–Ω—ã–µ</button>
            <button class="tab-btn" onclick="showTab('completed')">‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</button>
            <button class="tab-btn" onclick="showTab('history')">üí∞ –ò—Å—Ç–æ—Ä–∏—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π</button>
        </div>

        <div id="available" class="tab-content active">
            <h3>üìå –î–æ—Å—Ç—É–ø–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è</h3>
            <ul id="available-tasks"></ul>
        </div>

        <div id="active" class="tab-content">
            <h3>üöÄ –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è</h3>
            <ul id="active-tasks"></ul>
        </div>

        <div id="completed" class="tab-content">
            <h3>‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è</h3>
            <ul id="completed-tasks"></ul>
        </div>

        <div id="history" class="tab-content">
            <h3>üí∞ –ò—Å—Ç–æ—Ä–∏—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π</h3>
            <ul id="history-list"></ul>
        </div>

        <p id="debug-log" style="font-size: 12px; color: gray; white-space: pre-wrap;"></p>
    </div>

    <script>
        function logDebug(message) {
            console.log(message);  // –õ–æ–≥ –≤ DevTools (–µ—Å–ª–∏ –∑–∞–ø—É—â–µ–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ)
            document.getElementById("debug-log").innerText += `\n${message}`;  // –õ–æ–≥ –≤ Mini App
        }
        document.addEventListener("DOMContentLoaded", async function () {
            const tg = window.Telegram.WebApp;
            tg.expand();
            const apiUrl = window.env.API_URL;
            const telegramId = tg.initDataUnsafe.user.id;

            logDebug("üìå API URL: " + apiUrl);
            logDebug("üìå Telegram ID: " + telegramId);

            // üìå –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–¥–∞–Ω–∏—è
            async function loadTasks(category, elementId) {
                logDebug(`üìå –ó–∞–≥—Ä—É–∂–∞–µ–º ${category} –∑–∞–¥–∞–Ω–∏—è...`);
                
                if (!window.env || !window.env.API_URL) {
                    logDebug("‚ùå API_URL –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å env.js!");
                    return;
                }

                const apiUrl = window.env.API_URL;
                const endpoint = `${apiUrl}/tasks/${category}`;
                
                logDebug(`üìå –ó–∞–ø—Ä–æ—Å: ${endpoint}`);

                try {
                    const response = await fetch(endpoint);
                    const text = await response.text();  // –ß–∏—Ç–∞–µ–º –∫–∞–∫ —Ç–µ–∫—Å—Ç
                    logDebug(`üìå –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞ (${category}): ${text}`);

                    if (!response.ok) {
                        logDebug(`‚ùå –°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É: ${response.status} ${response.statusText}`);
                        return;
                    }

                    try {
                        const tasks = JSON.parse(text); // –ü—Ä–æ–±—É–µ–º —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON
                        logDebug(`‚úÖ –ü–æ–ª—É—á–µ–Ω—ã –∑–∞–¥–∞–Ω–∏—è: ${JSON.stringify(tasks)}`);
                        
                        const taskList = document.getElementById(elementId);
                        taskList.innerHTML = "";

                        tasks.forEach(task => {
                            const li = document.createElement("li");
                            li.innerHTML = `<b>${task.task_name}</b><br>${task.description}`;
                            taskList.appendChild(li);
                        });

                    } catch (jsonError) {
                        logDebug(`‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON: ${jsonError}`);
                    }
                } catch (error) {
                    logDebug(`‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ ${category}: ${error}`);
                }
            }



            // üìå –ë–µ—Ä–µ–º –∑–∞–¥–∞–Ω–∏–µ –≤ —Ä–∞–±–æ—Ç—É
            window.acceptTask = async function (taskId) {
                try {
                    logDebug(`üìå –ü—Ä–∏–Ω–∏–º–∞–µ–º –∑–∞–¥–∞–Ω–∏–µ ${taskId}`);
                    const response = await fetch(`${apiUrl}/tasks/${taskId}/accept`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ telegram_id: telegramId }),
                    });

                    if (response.ok) {
                        alert("–ó–∞–¥–∞–Ω–∏–µ –ø—Ä–∏–Ω—è—Ç–æ!");
                        logDebug("‚úÖ –ó–∞–¥–∞–Ω–∏–µ –ø—Ä–∏–Ω—è—Ç–æ");
                        loadTasks("", "available-tasks", true);
                        loadTasks("my", "active-tasks");
                    } else {
                        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–Ω—è—Ç–∏–∏ –∑–∞–¥–∞–Ω–∏—è");
                        logDebug("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏–Ω—è—Ç–∏—è –∑–∞–¥–∞–Ω–∏—è");
                    }
                } catch (error) {
                    logDebug("‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –ø—Ä–∏–Ω—è—Ç–∏–∏ –∑–∞–¥–∞–Ω–∏—è: " + error);
                }
            };

            // üìå –°–¥–∞—á–∞ –∑–∞–¥–∞–Ω–∏—è –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É
            window.submitTask = async function (taskId) {
                try {
                    logDebug(`üìå –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–¥–∞–Ω–∏–µ ${taskId} –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É`);
                    const response = await fetch(`${apiUrl}/tasks/${taskId}/submit`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ telegram_id: telegramId }),
                    });

                    if (response.ok) {
                        alert("–ó–∞–¥–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É!");
                        logDebug("‚úÖ –ó–∞–¥–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É");
                        loadTasks("my", "active-tasks");
                        loadTasks("completed", "completed-tasks");
                    } else {
                        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–¥–∞—á–µ –∑–∞–¥–∞–Ω–∏—è");
                        logDebug("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–¥–∞—á–µ –∑–∞–¥–∞–Ω–∏—è");
                    }
                } catch (error) {
                    logDebug("‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —Å–¥–∞—á–µ –∑–∞–¥–∞–Ω–∏—è: " + error);
                }
            };

            // üìå –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
            window.showTab = function (tabId) {
                document.querySelectorAll(".tab-content").forEach(tab => {
                    tab.classList.remove("active");
                });
                document.querySelectorAll(".tab-btn").forEach(button => {
                    button.classList.remove("active");
                });

                document.getElementById(tabId).classList.add("active");
                document.querySelector(`button[onclick="showTab('${tabId}')"]`).classList.add("active");
                logDebug(`üìå –ü–µ—Ä–µ–∫–ª—é—á–∏–ª–∏—Å—å –Ω–∞ –≤–∫–ª–∞–¥–∫—É: ${tabId}`);
            };

            // üìå –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–¥–∞–Ω–∏—è
            loadTasks("", "available-tasks", true);  // –í—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ (–¥–æ—Å—Ç—É–ø–Ω—ã–µ)
            loadTasks("my", "active-tasks");  // –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è —é–∑–µ—Ä–∞
            loadTasks("completed", "completed-tasks");  // –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ
            loadTasks("history", "history-list");  // –ò—Å—Ç–æ—Ä–∏—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π (–ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ)
        });
    </script>

</body>
</html>
