<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ó–∞–¥–∞–Ω–∏—è</title>
    <link rel="stylesheet" href="/static/styles.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="./env.js"></script>  <!-- –ó–∞–≥—Ä—É–∂–∞–µ–º API_URL -->
</head>
<body>
    <div class="container">
        <h2>–ó–∞–¥–∞–Ω–∏—è</h2>
        
        <!-- üîó –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∞–∫–∫–∞—É–Ω—Ç–æ–≤ -->
        <button onclick="window.location.href='/accounts.html'">üîó –ü—Ä–∏–≤—è–∑–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç—ã</button>

        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('available')">üìå –î–æ—Å—Ç—É–ø–Ω—ã–µ</button>
            <button class="tab-btn" onclick="showTab('active')">üöÄ –ê–∫—Ç–∏–≤–Ω—ã–µ</button>
            <button class="tab-btn" onclick="showTab('completed')">‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</button>
            <button class="tab-btn" onclick="showTab('history')">üí∞ –ò—Å—Ç–æ—Ä–∏—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π</button>
        </div>

        <div id="available" class="tab-content active">
            <h3>üìå –î–æ—Å—Ç—É–ø–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è</h3>
            <ul id="available-tasks"></ul>
        </div>

        <div id="active" class="tab-content">
            <h3>üöÄ –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è</h3>
            <ul id="active-tasks"></ul>
        </div>

        <div id="completed" class="tab-content">
            <h3>‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è</h3>
            <ul id="completed-tasks"></ul>
        </div>

        <div id="history" class="tab-content">
            <h3>üí∞ –ò—Å—Ç–æ—Ä–∏—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π</h3>
            <ul id="history-list"></ul>
        </div>

        <p id="debug-log" style="font-size: 12px; color: gray; white-space: pre-wrap;"></p>
    </div>

    <script>
        function logDebug(message) {
            console.log(message);
            document.getElementById("debug-log").innerText += `\n${message}`;
        }

        document.addEventListener("DOMContentLoaded", async function () {
            const tg = window.Telegram.WebApp;
            tg.expand();

            if (!window.env || !window.env.API_URL) {
                logDebug("‚ùå API_URL –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å env.js!");
                return;
            }

            const apiUrl = window.env.API_URL;
            logDebug("üìå API URL: " + apiUrl);

            const telegramId = tg.initDataUnsafe?.user?.id;
            if (!telegramId) {
                logDebug("‚ùå Telegram ID –Ω–µ –Ω–∞–π–¥–µ–Ω!");
                return;
            }
            logDebug("üìå Telegram ID: " + telegramId);

            // üìå –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞–Ω–∏–π
            async function loadTasks(category, elementId) {
                logDebug(`üìå –ó–∞–≥—Ä—É–∂–∞–µ–º ${category} –∑–∞–¥–∞–Ω–∏—è...`);
                const endpoint = `${apiUrl}/tasks/${category}?telegram_id=${telegramId}`;

                try {
                    const headers = {
                        "Accept": "application/json",
                        "ngrok-skip-browser-warning": "true"
                    };

                    logDebug(`üìå –ó–∞–ø—Ä–æ—Å: ${endpoint}`);
                    logDebug(`üìå –ó–∞–≥–æ–ª–æ–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞: ${JSON.stringify(headers)}`);

                    const response = await fetch(endpoint, {
                        headers,
                        mode: "cors",
                        cache: "no-store"
                    });

                    logDebug(`üìå –°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞ (${category}): ${response.status} ${response.statusText}`);

                    if (!response.ok) {
                        logDebug(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: ${response.status} ${response.statusText}`);
                        return;
                    }

                    const tasks = await response.json();
                    logDebug(`‚úÖ –ü–æ–ª—É—á–µ–Ω—ã –∑–∞–¥–∞–Ω–∏—è: ${JSON.stringify(tasks)}`);

                    const taskList = document.getElementById(elementId);
                    taskList.innerHTML = "";

                    tasks.forEach(task => {
                        const li = document.createElement("li");
                        li.innerHTML = `
                            <b>${task.description}</b> - üí∞ ${task.reward}
                            <br>
                            <button onclick="acceptTask('${task.task_id}')">üöÄ –ü—Ä–∏–Ω—è—Ç—å</button>
                            <button onclick="viewTask('${task.task_id}')">üëÄ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å</button>
                        `;
                        taskList.appendChild(li);
                    });

                } catch (error) {
                    logDebug(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ${category}: ${error}`);
                }
            }

            // üìå –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–æ–≤
            async function loadAccountsToCache() {
                const apiUrl = window.env.API_URL;
                const telegramId = tg.initDataUnsafe?.user?.id;

                try {
                    const response = await fetch(`${apiUrl}/accounts?telegram_id=${telegramId}`, {
                        headers: { "Accept": "application/json", "ngrok-skip-browser-warning": "true" }
                    });

                    const accounts = await response.json();
                    if (response.ok && accounts.length > 0) {
                        localStorage.setItem("user_accounts", JSON.stringify(accounts));
                        logDebug("‚úÖ –ê–∫–∫–∞—É–Ω—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –∫–µ—à: " + JSON.stringify(accounts));
                    } else {
                        logDebug("‚ùå –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–æ–≤!");
                    }
                } catch (error) {
                    logDebug(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–æ–≤: ${error}`);
                }
            }

            // üìå –ü–æ–ª—É—á–∞–µ–º –∞–∫–∫–∞—É–Ω—Ç—ã –∏–∑ –∫–µ—à–∞ (–∏–ª–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç)
            function getCachedAccounts() {
                const cachedAccounts = localStorage.getItem("user_accounts");
                return cachedAccounts ? JSON.parse(cachedAccounts) : null;
            }

            // üìå –§—É–Ω–∫—Ü–∏—è –ø—Ä–∏–Ω—è—Ç–∏—è –∑–∞–¥–∞–Ω–∏—è
            async function acceptTask(taskId) {
                const telegramId = tg.initDataUnsafe?.user?.id;
                if (!telegramId) {
                    alert("–û—à–∏–±–∫–∞: Telegram ID –Ω–µ –Ω–∞–π–¥–µ–Ω.");
                    return;
                }

                let accounts = getCachedAccounts();
                if (!accounts) {
                    await loadAccountsToCache();
                    accounts = getCachedAccounts();
                }

                if (!accounts || accounts.length === 0) {
                    alert("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤. –°–Ω–∞—á–∞–ª–∞ –ø—Ä–∏–≤—è–∂–∏—Ç–µ –∞–∫–∫–∞—É–Ω—Ç!");
                    window.location.href = "/accounts.html";
                    return;
                }

                let accountId;
                if (accounts.length === 1) {
                    accountId = accounts[0].account_id;
                } else {
                    accountId = prompt("–í—ã–±–µ—Ä–∏—Ç–µ ID –∞–∫–∫–∞—É–Ω—Ç–∞ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è:\n" +
                        accounts.map(acc => `${acc.account_id}: ${acc.account_name} (${acc.platform})`).join("\n"));
                    if (!accountId) return;
                }

                logDebug(`üìå –ü—Ä–∏–Ω—è—Ç–∏–µ –∑–∞–¥–∞–Ω–∏—è ${taskId} —Å –∞–∫–∫–∞—É–Ω—Ç–æ–º ${accountId}`);

                fetch(`${window.env.API_URL}/tasks/${taskId}/accept`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "ngrok-skip-browser-warning": "true" },
                    body: JSON.stringify({ telegram_id: telegramId, account_id: accountId }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(`‚ùå –û—à–∏–±–∫–∞: ${data.error}`);
                    } else {
                        alert("‚úÖ –ó–∞–¥–∞–Ω–∏–µ –ø—Ä–∏–Ω—è—Ç–æ!");
                        logDebug("‚úÖ –ü—Ä–∏–Ω—è—Ç–æ: " + JSON.stringify(data));
                        window.history.back();
                    }
                })
                .catch(error => {
                    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏–Ω—è—Ç–∏—è –∑–∞–¥–∞–Ω–∏—è:", error);
                    alert("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–Ω—è—Ç–∏–∏ –∑–∞–¥–∞–Ω–∏—è.");
                });
            }

            // üìå –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–∫–∫–∞—É–Ω—Ç—ã –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
            document.addEventListener("DOMContentLoaded", loadAccountsToCache);

            // üìå –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–¥–∞–Ω–∏—è
            loadTasks("", "available-tasks");
            loadTasks("my", "active-tasks");
            loadTasks("completed", "completed-tasks");
            loadTasks("history", "history-list");

            window.viewTask = function (taskId) {
                window.location.href = `./task_details.html?task_id=${taskId}`;
            };
        });
    </script>
</body>
</html>
