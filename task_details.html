<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–µ—Ç–∞–ª–∏ –∑–∞–¥–∞–Ω–∏—è</title>
    <link rel="stylesheet" href="/static/styles.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="./env.js"></script>
</head>
<body>
    <div class="container">
        <h2 id="task-title">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
        <p id="task-description"></p>
        <p id="task-reward"></p>
        <p id="task-status"></p>
        <button id="accept-task-btn" style="display:none;">üöÄ –ü—Ä–∏–Ω—è—Ç—å –∑–∞–¥–∞–Ω–∏–µ</button>
        <button onclick="goBack()">‚¨Ö –ù–∞–∑–∞–¥</button>
    </div>

    <script>
        function logDebug(message) {
            console.log(message);
        }

        function goBack() {
            window.history.back();
        }

        const tg = window.Telegram.WebApp;
        const apiUrl = window.env.API_URL;
        const telegramId = tg.initDataUnsafe?.user?.id;
        const urlParams = new URLSearchParams(window.location.search);
        const taskId = urlParams.get("task_id");

        // üìå –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–æ–≤
        async function loadAccountsToCache() {
            try {
                const response = await fetch(`${apiUrl}/accounts?telegram_id=${telegramId}`, {
                    headers: { "Accept": "application/json", "ngrok-skip-browser-warning": "true" }
                });

                const accounts = await response.json();
                if (response.ok && accounts.length > 0) {
                    localStorage.setItem("user_accounts", JSON.stringify(accounts));
                    logDebug("‚úÖ –ê–∫–∫–∞—É–Ω—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –∫–µ—à: " + JSON.stringify(accounts));
                }
            } catch (error) {
                logDebug(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–æ–≤: ${error}`);
            }
        }

        function getCachedAccounts() {
            const data = localStorage.getItem("user_accounts");
            return data ? JSON.parse(data) : null;
        }

        async function acceptTask(taskId) {
            if (!telegramId) {
                alert("–û—à–∏–±–∫–∞: Telegram ID –Ω–µ –Ω–∞–π–¥–µ–Ω.");
                return;
            }

            let accounts = getCachedAccounts();
            if (!accounts) {
                await loadAccountsToCache();
                accounts = getCachedAccounts();
            }

            if (!accounts || accounts.length === 0) {
                alert("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤. –°–Ω–∞—á–∞–ª–∞ –ø—Ä–∏–≤—è–∂–∏—Ç–µ –∞–∫–∫–∞—É–Ω—Ç!");
                window.location.href = "/accounts.html";
                return;
            }

            let accountId;
            if (accounts.length === 1) {
                accountId = accounts[0].account_id;
            } else {
                accountId = prompt("–í—ã–±–µ—Ä–∏—Ç–µ ID –∞–∫–∫–∞—É–Ω—Ç–∞:\n" +
                    accounts.map(a => `${a.account_id}: ${a.account_name} (${a.platform})`).join("\n"));
                if (!accountId) return;
            }

            logDebug(`üìå –ü—Ä–∏–Ω—è—Ç–∏–µ –∑–∞–¥–∞–Ω–∏—è ${taskId} —Å –∞–∫–∫–∞—É–Ω—Ç–æ–º ${accountId}`);

            try {
                const response = await fetch(`${apiUrl}/tasks/${taskId}/accept?telegram_id=${telegramId}`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "ngrok-skip-browser-warning": "true"
                    },
                    body: JSON.stringify({ account_id: accountId })  // –¢–æ–ª—å–∫–æ account_id –≤ —Ç–µ–ª–µ!
                });

                const result = await response.json();
                if (response.ok) {
                    alert("‚úÖ –ó–∞–¥–∞–Ω–∏–µ –ø—Ä–∏–Ω—è—Ç–æ!");
                    logDebug("‚úÖ –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: " + JSON.stringify(result));
                    goBack();
                } else {
                    alert(`‚ùå –û—à–∏–±–∫–∞: ${result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
                }
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏–Ω—è—Ç–∏—è –∑–∞–¥–∞–Ω–∏—è:", error);
                alert("‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –ø—Ä–∏–Ω—è—Ç–∏–∏ –∑–∞–¥–∞–Ω–∏—è.");
            }
        }

        async function loadTaskDetails() {
            if (!taskId) {
                document.getElementById("task-title").innerText = "–û—à–∏–±–∫–∞!";
                document.getElementById("task-description").innerText = "–ó–∞–¥–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.";
                return;
            }

            try {
                const response = await fetch(`${apiUrl}/tasks/${taskId}?telegram_id=${telegramId}`, {
                    headers: { "ngrok-skip-browser-warning": "true" }
                });

                const task = await response.json();

                document.getElementById("task-title").innerText = task.description;
                document.getElementById("task-description").innerText = `–û–ø–∏—Å–∞–Ω–∏–µ: ${task.description}`;
                document.getElementById("task-reward").innerText = `üí∞ –í–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ: ${task.reward}`;
                document.getElementById("task-status").innerText = `üìå –°—Ç–∞—Ç—É—Å: ${task.status_id}`;

                if (task.status_id === "active") {
                    const btn = document.getElementById("accept-task-btn");
                    btn.style.display = "block";
                    btn.onclick = () => acceptTask(taskId);
                }
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞–Ω–∏—è:", error);
                document.getElementById("task-title").innerText = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏!";
                document.getElementById("task-description").innerText = "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ.";
            }
        }

        // üìå –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener("DOMContentLoaded", () => {
            tg.expand();
            loadAccountsToCache();
            loadTaskDetails();
        });
    </script>
</body>
</html>
