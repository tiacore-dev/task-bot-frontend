<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–µ—Ç–∞–ª–∏ –∑–∞–¥–∞–Ω–∏—è</title>
    <link rel="stylesheet" href="/static/styles.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="./env.js"></script>
</head>
<body>
    <div class="container">
        <h2 id="task-title">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
        <p id="task-description"></p>
        <p id="task-reward"></p>
        <p id="task-status"></p>
        <button id="accept-task-btn" style="display:none;">üöÄ –ü—Ä–∏–Ω—è—Ç—å –∑–∞–¥–∞–Ω–∏–µ</button>
        <button onclick="goBack()">‚¨Ö –ù–∞–∑–∞–¥</button>
    </div>

    <script>
        function logDebug(message) {
            console.log(message);
        }

        // –ü–æ–ª—É—á–∞–µ–º ID –∑–∞–¥–∞–Ω–∏—è –∏–∑ URL
        const urlParams = new URLSearchParams(window.location.search);
        const taskId = urlParams.get("task_id");

        if (!taskId) {
            document.getElementById("task-title").innerText = "–û—à–∏–±–∫–∞!";
            document.getElementById("task-description").innerText = "–ó–∞–¥–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.";
        } else {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–µ—Ç–∞–ª–∏ –∑–∞–¥–∞–Ω–∏—è
            //fetch(`${window.env.API_URL}/tasks/${taskId}`)
            fetch(`${window.env.API_URL}/tasks/${taskId}`, {
                method: "GET",
                headers: { "ngrok-skip-browser-warning": "true" },
            })
                .then(response => response.json())
                .then(task => {
                    document.getElementById("task-title").innerText = task.description;
                    document.getElementById("task-description").innerText = `–û–ø–∏—Å–∞–Ω–∏–µ: ${task.description}`;
                    document.getElementById("task-reward").innerText = `üí∞ –í–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ: ${task.reward}`;
                    document.getElementById("task-status").innerText = `üìå –°—Ç–∞—Ç—É—Å: ${task.status_id}`;

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ü—Ä–∏–Ω—è—Ç—å –∑–∞–¥–∞–Ω–∏–µ", –µ—Å–ª–∏ –æ–Ω–æ –µ—â—ë –Ω–µ –ø—Ä–∏–Ω—è—Ç–æ
                    if (task.status_id === "active") {
                        document.getElementById("accept-task-btn").style.display = "block";
                        document.getElementById("accept-task-btn").onclick = () => acceptTask(taskId);
                    }
                })
                .catch(error => {
                    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞–Ω–∏—è:", error);
                    document.getElementById("task-title").innerText = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏!";
                    document.getElementById("task-description").innerText = "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ.";
                });
        }

        // –§—É–Ω–∫—Ü–∏—è –ø—Ä–∏–Ω—è—Ç–∏—è –∑–∞–¥–∞–Ω–∏—è
        function acceptTask(taskId) {
            const tg = window.Telegram.WebApp;
            const telegramId = tg.initDataUnsafe?.user?.id;
            if (!telegramId) {
                alert("–û—à–∏–±–∫–∞: Telegram ID –Ω–µ –Ω–∞–π–¥–µ–Ω.");
                return;
            }

            fetch(`${window.env.API_URL}/tasks/${taskId}/accept`, {
                method: "POST",
                headers: { "Content-Type": "application/json", "ngrok-skip-browser-warning": "true" },
                body: JSON.stringify({ telegram_id: telegramId }),
            })
            .then(response => response.json())
            .then(data => {
                alert("‚úÖ –ó–∞–¥–∞–Ω–∏–µ –ø—Ä–∏–Ω—è—Ç–æ!");
                logDebug("‚úÖ –ü—Ä–∏–Ω—è—Ç–æ: " + JSON.stringify(data));
                window.history.back();
            })
            .catch(error => {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏–Ω—è—Ç–∏—è –∑–∞–¥–∞–Ω–∏—è:", error);
                alert("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–Ω—è—Ç–∏–∏ –∑–∞–¥–∞–Ω–∏—è.");
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –Ω–∞–∑–∞–¥
        function goBack() {
            window.history.back();
        }
    </script>
</body>
</html>
