<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–µ—Ç–∞–ª–∏ –∑–∞–¥–∞–Ω–∏—è</title>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="/static/styles.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="./env.js"></script>
</head>
<body>
    <div class="container">
        <h2 id="task-title">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
        <p id="task-description"></p>
        <p id="task-reward"></p>
        <p id="task-status"></p>
        <div class="text-center my-3">
            <button id="accept-task-btn" class="btn btn-success" style="display: none;">
                üöÄ –ü—Ä–∏–Ω—è—Ç—å –∑–∞–¥–∞–Ω–∏–µ
            </button>
        </div>
        
        <button onclick="goBack()">‚¨Ö –ù–∞–∑–∞–¥</button>
    </div>
    <div class="modal fade" id="accountModal" tabindex="-1" aria-labelledby="accountModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content shadow">
            <div class="modal-header">
              <h5 class="modal-title" id="accountModalLabel">–í—ã–±–µ—Ä–∏—Ç–µ –∞–∫–∫–∞—É–Ω—Ç</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
            </div>
            <div class="modal-body">
              <ul id="account-options" class="list-group"></ul>
            </div>
          </div>
        </div>
      </div>
      
    <script>
        function logDebug(message) {
            console.log(message);
        }

        function goBack() {
            window.history.back();
        }

        const tg = window.Telegram.WebApp;
        const apiUrl = window.env.API_URL;
        const telegramId = tg.initDataUnsafe?.user?.id;
        const urlParams = new URLSearchParams(window.location.search);
        const taskId = urlParams.get("task_id");

        // üìå –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–æ–≤
        async function loadAccountsToCache() {
            try {
                const response = await fetch(`${apiUrl}/accounts?telegram_id=${telegramId}`, {
                    headers: { "Accept": "application/json", "ngrok-skip-browser-warning": "true" }
                });

                const accounts = await response.json();
                if (response.ok && accounts.length > 0) {
                    localStorage.setItem("user_accounts", JSON.stringify(accounts));
                    logDebug("‚úÖ –ê–∫–∫–∞—É–Ω—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –∫–µ—à: " + JSON.stringify(accounts));
                }
            } catch (error) {
                logDebug(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–æ–≤: ${error}`);
            }
        }

        function getCachedAccounts() {
            const data = localStorage.getItem("user_accounts");
            return data ? JSON.parse(data) : null;
        }

        async function acceptTask(taskId) {
            if (!telegramId) {
                alert("–û—à–∏–±–∫–∞: Telegram ID –Ω–µ –Ω–∞–π–¥–µ–Ω.");
                return;
            }

            let accounts = getCachedAccounts();
            if (!accounts) {
                await loadAccountsToCache();
                accounts = getCachedAccounts();
            }

            if (!accounts || accounts.length === 0) {
                alert("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤. –°–Ω–∞—á–∞–ª–∞ –ø—Ä–∏–≤—è–∂–∏—Ç–µ –∞–∫–∫–∞—É–Ω—Ç!");
                window.location.href = "/accounts.html";
                return;
            }

            if (accounts.length === 1) {
                const accountId = accounts[0].account_id;
                localStorage.setItem("selectedAccount", accountId);
                await sendAcceptRequest(accountId);
            } else {
                showAccountSelector(accounts);
            }
        }


        async function sendAcceptRequest(accountId) {
            try {
                const response = await fetch(`${apiUrl}/tasks/${taskId}/accept?telegram_id=${telegramId}`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "ngrok-skip-browser-warning": "true"
                    },
                    body: JSON.stringify({ account_id: accountId })
                });

                const result = await response.json();
                if (response.ok) {
                    alert("‚úÖ –ó–∞–¥–∞–Ω–∏–µ –ø—Ä–∏–Ω—è—Ç–æ!");
                    logDebug("‚úÖ –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: " + JSON.stringify(result));
                    goBack();
                } else {
                    alert(`‚ùå –û—à–∏–±–∫–∞: ${result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
                }
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏–Ω—è—Ç–∏—è –∑–∞–¥–∞–Ω–∏—è:", error);
                alert("‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –ø—Ä–∏–Ω—è—Ç–∏–∏ –∑–∞–¥–∞–Ω–∏—è.");
            }
        }

        let modalInstance;

        function showAccountSelector(accounts) {
            const list = document.getElementById("account-options");
            list.innerHTML = "";

            accounts.forEach(account => {
                const li = document.createElement("li");
                li.className = "list-group-item list-group-item-action";
                li.style.cursor = "pointer";
                li.innerHTML = `
                    <b>${account.account_name}</b> (${account.platform})<br>
                    <small>${account.account_platform_id}</small>
                `;
                li.onclick = () => {
                    const selectedId = account.account_id;
                    localStorage.setItem("selectedAccount", selectedId);
                    const modal = bootstrap.Modal.getInstance(document.getElementById("accountModal"));
                    modal.hide();
                    sendAcceptRequest(selectedId);
                };
                list.appendChild(li);
            });

            const modalEl = document.getElementById("accountModal");
            modalInstance = new bootstrap.Modal(modalEl);
            modalInstance.show();
        }



        async function loadTaskDetails() {
            if (!taskId) {
                document.getElementById("task-title").innerText = "–û—à–∏–±–∫–∞!";
                document.getElementById("task-description").innerText = "–ó–∞–¥–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.";
                return;
            }

            try {
                const response = await fetch(`${apiUrl}/tasks/${taskId}?telegram_id=${telegramId}`, {
                    headers: { "ngrok-skip-browser-warning": "true" }
                });

                const task = await response.json();

                document.getElementById("task-title").innerText = task.description;
                document.getElementById("task-description").innerText = `–û–ø–∏—Å–∞–Ω–∏–µ: ${task.description}`;
                document.getElementById("task-reward").innerText = `üí∞ –í–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ: ${task.reward}`;
                document.getElementById("task-status").innerText = `üìå –°—Ç–∞—Ç—É—Å: ${task.status_id}`;

                if (task.status_id === "active") {
                    const btn = document.getElementById("accept-task-btn");
                    btn.style.display = "block";
                    btn.onclick = () => acceptTask(taskId);
                }
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞–Ω–∏—è:", error);
                document.getElementById("task-title").innerText = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏!";
                document.getElementById("task-description").innerText = "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ.";
            }
        }

        // üìå –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener("DOMContentLoaded", () => {
            tg.expand();
            loadAccountsToCache();
            loadTaskDetails();
        });
    </script>
</body>
</html>
